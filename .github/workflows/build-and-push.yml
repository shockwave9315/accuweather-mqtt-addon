name: Build and Push Add-on

on:
  push:
    branches:
      - main # Uruchamia workflow przy każdym pushu do gałęzi 'main'
  workflow_dispatch: # Pozwala na ręczne uruchomienie workflow z interfejsu GitHub

jobs:
  build-and-push:
    runs-on: ubuntu-latest # Wybiera środowisko uruchomieniowe (maszynę wirtualną)

    steps:
      - name: Checkout repository # Klonuje Twoje repozytorium
        uses: actions/checkout@v4

      - name: Set up Docker Buildx # Konfiguruje Buildx dla Docker, niezbędne do budowania multi-platformowych obrazów
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry # Loguje się do GHCR, aby móc pushować obrazy
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }} # Automatycznie pobiera Twoją nazwę użytkownika GitHub
          password: <span class="math-inline">\{\{ secrets\.GITHUB\_TOKEN \}\} \# Używa automatycznie generowanego tokenu do uwierzytelnienia
\- name\: Get Add\-on Version from config\.json \# Pobiera wersję dodatku z config\.json
id\: get\_version \# Identyfikator tego kroku, aby móc odwołać się do jego wyjścia
run\: \|
VERSION\=</span>(jq -r '.version' addons/accuweather_mqtt/config.json)
          echo "ADDON_VERSION=${VERSION}" >> <span class="math-inline">GITHUB\_OUTPUT
\- name\: Build and push Docker image \# Buduje i publikuje obraz Dockera dla różnych architektur
uses\: docker/build\-push\-action@v5
with\:
context\: \./addons/accuweather\_mqtt/ \# Ścieżka do katalogu z Dockerfile i plikami dodatku
platforms\: linux/amd64,linux/arm64,linux/arm/v7,linux/arm/v6,linux/i386 \# Architektury, dla których budujemy obraz
push\: true \# Włącza pushowanie obrazu do registry
tags\: \| \# Definiuje tagi dla obrazów, z dynamiczną wersją i architekturą
ghcr\.io/shockwave9315/accuweather\-mqtt\-addon\_amd64\:</span>{{ steps.get_version.outputs.ADDON_VERSION }}
            ghcr.io/shockwave9315/accuweather-mqtt-addon_arm64:<span class="math-inline">\{\{ steps\.get\_version\.outputs\.ADDON\_VERSION \}\}
ghcr\.io/shockwave9315/accuweather\-mqtt\-addon\_armv7\:</span>{{ steps.get_version.outputs.ADDON_VERSION }}
            ghcr.io/shockwave9315/accuweather-mqtt-addon_armhf:<span class="math-inline">\{\{ steps\.get\_version\.outputs\.ADDON\_VERSION \}\}
ghcr\.io/shockwave9315/accuweather\-mqtt\-addon\_i386\:</span>{{ steps.get_version.outputs.ADDON_VERSION }}
          # Kluczowa sekcja: Przekazujemy BUILD_ARCH z odpowiednim obrazem bazowym dla każdej platformy
          build-args: |
            BUILD_ARCH_amd64=amd64
            BUILD_ARCH_arm64=aarch64 # arm64 zazwyczaj używa aarch
